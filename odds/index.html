<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>D3 Demo: SVG with pretty colors</title>
    <script type="text/javascript" src="../d3/d3.v3.js"></script>
    <style type="text/css">
      .axis path,
      .axis line {
        fill: none;
        stroke: black;
        shape-rendering: crispEdges;
      }

      .axis text {
        font-family: sans-serif;
        font-size: 11px;
      }


      #tooltip {
        position: absolute;
        width: 200px;
        height: auto;
        padding: 10px;
        background-color: white;
        opacity: 0.85;
        -webkit-border-radius: 10px;
        -moz-border-radius: 10px;
        border-radius: 10px;
        -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        pointer-events: none;
      }

      #tooltip.hidden {
              display: none;
      }

      #tooltip p {
              margin: 0;
              font-family: sans-serif;
              font-size: 16px;
              line-height: 20px;
      }

      #csvdata{display: none;}

    </style>
  </head>
  <body>
    <script type="text/javascript">

      //Width and height
      //http://bl.ocks.org/mbostock/3019563
      var margin = {top: 20, right: 20, bottom: 20, left: 20},
          padding = {top: 60, right: 60, bottom: 60, left: 60},
          outerWidth = 960,
          outerHeight = 650,
          innerWidth = outerWidth - margin.left - margin.right,
          innerHeight = outerHeight - margin.top - margin.bottom,
          width = innerWidth - padding.left - padding.right,
          height = innerHeight - padding.top - padding.bottom,
          xLegend = width - 200,
          yLegend = 9,
          legendWidth = 18,
          legendHeight = 18,
          yLabelPadding = 15
          ;

      var hoverColor = "hsl(220, 70%, 65%)";
      var xColumn = "team";
      var yData = [
        {key: "l2w", color: "hsl(120, 70%, 65%)",
          legend: "Unexpected win on predicted loss",
          tooltip: " unexpected win(s) on predicted loss(es)"
        },
        // {key: "d2w", color: "hsl(96, 70%, 65%)",
        //   legend: "Unexpected win on predicted draw",
        //   tooltip: " unexpected win(s) on predicted draw(s)"
        // },
        {key: "l2d", color: "hsl(72, 70%, 65%)",
          legend: "Unexpected draw on predicted loss",
          tooltip: " unexpected draw(s) on predicted loss(es)"
        },
        {key: "w2d", color: "hsl(48, 70%, 65%)",
          legend: "Unexpected draw on predicted win",
          tooltip: " unexpected draw(s) on predicted win(s)"
        },
        // {key: "d2l", color: "hsl(24, 70%, 65%)",
        //   legend: "Unexpected loss on predicted draw",
        //   tooltip: " unexpected loss(es) on predicted draw(s)"
        // },
        {key: "w2l", color: "hsl(0, 70%, 65%)",
          legend: "Unexpected loss on predicted win",
          tooltip: " unexpected loss(es) on predicted win(s)"
        }
      ]

      //Create SVG element
      var svg = d3.select("body")
        .append("svg")
        .attr("width", outerWidth)
        .attr("height", outerHeight)
        ;
      var g = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
        ;

      //Scales
      var xScale = d3.scale.ordinal()
        .rangeRoundBands([0, width], 0.05)
        ;
      var yScale = d3.scale.linear()
        .range([0, height])
        ;

      //Axes
      var xAxisG = svg.append("g")
        .attr("class", "x axis")
        .attr("transform",
          "translate("+ margin.left +"," +
            (innerHeight-padding.bottom-margin.bottom) + ")")
        ;

      var xAxis = d3.svg.axis()
        .scale(xScale)
        .orient("bottom")
        ;

      function render(data){
        // change number-strings (from CSV) into nums and transpose data for
        // the stack() method to consume
        var layers = yData.map(function(y){return y.key})
          .map(function(c) {
          return data.map(function(d){
            d[c] = +d[c];
            return {x: d[xColumn], y: d[c], key:c};
          })
        });

        // Applying the stack() method adds the y0 baseline attribute
        layers = d3.layout.stack()(layers);

        //Set up scales' domains
        xScale.domain(data.map(function(d) { return d[xColumn]; }));
        yScale.domain([0,
          d3.max(layers, function(d) {
            return d3.max(d, function(d) {
              return d.y0 + d.y;
            });
          })
        ]);

        //Draw axes
        xAxisG.call(xAxis)
          .selectAll("text")
          .style("text-anchor", "end")
          .attr("dx", "-.8em")
          .attr("dy", ".15em")
          .attr("transform", "rotate(-65)" );
        ;

        // Add a group for each row of data
        var groups = g.selectAll("g")
          .data(layers)
          .enter()
          .append("g")
          .style("fill", function(d, i) {
            return yData[i].color;
          })
          ;

        // Add a rect for each data value
        var rects = groups.selectAll("rect")
          .data(function(d) { return d; })
          ;
        rects.enter()
          .append("rect")
          .attr("x", function(d, i) {
            return xScale(d.x);
          })
          .attr("y", function(d) {
            return height - yScale(d.y0) - yScale(d.y);
          })
          .attr("height", function(d) {
            return yScale(d.y);
          })
          .attr("width", xScale.rangeBand())
          .on("mouseover", function(d) {
            //Highlight this bar on hover
            d3.select(this)
            .attr("fill", hoverColor);

            //Get this bar's x/y values, then augment for the tooltip
            var xPosition = parseFloat(d3.select(this).attr("x")) + xScale.rangeBand() / 2;
            var yPosition = parseFloat(d3.select(this).attr("y"));
            //Update the tooltip position and value
            d3.select("#tooltip")
              .style("left", xPosition + "px")
              .style("top", yPosition + "px")
              .select("#value")
              .text(d.y + yData.filter(function(obj){return obj.key==d.key})[0].tooltip);
            //Show the tooltip
            d3.select("#tooltip").classed("hidden", false);
          })
          .on("mouseout", function(d) {
            //Reset bar's original color on mouseout
            d3.select(this)
            .transition()
            .duration(250)
            .attr("fill", yData.filter(function(obj){return obj.key==d.key})[0].color);

            //Hide the tooltip on mouseout
            d3.select("#tooltip").classed("hidden", true);
          })
          ;

        rects.exit().remove();


        //Labels
        // Add a group for each text
        var labG = svg.append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
          ;

        var labelG = labG.selectAll("g")
          .data(layers)
          .enter()
          .append("g")
          .attr("class", "labels")
          ;

        // Add a label for each data value
        var labels = labelG.selectAll("rect")
          .data(function(d) { return d; })
          ;

        labels.enter()
          .append("text")
          .text(function(d) {
            if (d.y == 0){ return ""};
            return d.y;
          })
          .attr("text-anchor", "middle")
          .attr("x", function(d, i) {
            return xScale(d.x) + xScale.rangeBand()/2;
          })
          .attr("y", function(d) {
            return height - yScale(d.y0) - yScale(d.y) + yLabelPadding;
          })
          .attr("font-family", "sans-serif")
          .attr("font-size", "11px")
          .attr("fill", "white")
          ;

        labels.exit().remove();



        //legend
        var legend = svg.selectAll(".legend")
          .data(yData);

        legend.enter().append("g")
          .attr("class", "legend")
          .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

        legend.append("rect")
          .attr("x", xLegend)
          .attr("width", legendWidth)
          .attr("height", legendHeight)
          .style("fill", function(d){return d.color})
          ;

        legend.append("text")
          .attr("x", xLegend + 24)
          .attr("y", yLegend)
          .attr("dy", ".35em")
          .style("text-anchor", "start")
          .text(function(d) { return d.legend; });

        legend.exit().remove();


      }; //end of render function

      //Load from CSV File
      // d3.csv("odds_beaten.csv", render);

      //OR

      //Load from embedded csv in html
      window.onload = function() {
        var raw = d3.select("#csvdata").text();
        console.log(raw);
        var parsedOddsData = d3.csv.parse(raw);
        console.log(parsedOddsData);
        render(parsedOddsData);
      };

    </script>

    <!-- Div to be used for tooltip -->
    <div id="tooltip" class="hidden">
        <p><span id="value">100</span></p>
    </div>

<pre id="csvdata">
team,oddities,points,l2w,l2d,w2d,w2l
Arsenal,6,42,0,0,3,3
Leicester,12,40,5,5,2,0
"Man City",7,39,0,1,2,4
Tottenham,12,36,2,3,6,1
"Man United",10,33,0,0,6,4
"West Ham",17,32,7,3,5,2
"Crystal Palace",11,31,5,3,1,2
Liverpool,13,30,2,3,3,5
Watford,10,29,4,4,1,1
Stoke,16,29,7,4,1,4
Everton,13,27,2,4,5,2
"West Brom",10,26,4,5,0,1
Southampton,13,24,2,1,5,5
Chelsea,13,23,0,2,3,8
Norwich,11,23,3,4,1,3
Bournemouth,12,21,4,3,3,2
Swansea,10,19,1,2,5,2
Newcastle,9,17,3,3,2,1
Sunderland,6,15,2,3,0,1
"Aston Villa",9,8,1,3,2,3</pre>

  </body>
</html>
